<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ˆæä¸“æ³¨ç•ªèŒ„é’Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        warning: '#FBBF24',
                        dark: '#1F2937',
                        light: '#F3F4F6'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .timer-shadow {
                box-shadow: 0 10px 30px -5px rgba(59, 130, 246, 0.3);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:scale-105 active:scale-95;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .task-item {
                @apply bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow cursor-pointer;
            }
            .task-item:hover {
                @apply border-primary/50;
            }
            .section-divider {
                @apply border-t border-gray-200 my-6 pt-6;
            }
            .badge {
                @apply text-xs px-2 py-0.5 rounded-full;
            }
            .toggle-checkbox:checked {
                right: 0;
                border-color: #68D391;
            }
            .toggle-checkbox:checked + .toggle-label {
                background-color: #68D391;
            }
            .review-square {
                @apply relative inline-block w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 p-1 m-1 text-center overflow-hidden transition-all cursor-pointer hover:shadow-md;
            }
            .review-square.completed {
                @apply bg-secondary/20 border-secondary text-secondary;
            }
            .review-square.pending {
                @apply bg-white border-gray-300 text-gray-700;
            }
            .review-square.future {
                @apply bg-gray-100 border-gray-200 text-gray-500;
            }
            .review-tooltip {
                @apply absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-48 bg-dark text-white text-xs rounded py-1 px-2 opacity-0 invisible transition-all duration-200 pointer-events-none;
            }
            .review-square:hover .review-tooltip {
                @apply opacity-100 visible;
            }
            .review-note {
                @apply hidden mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded border border-gray-100;
            }
            .review-note.visible {
                @apply block;
            }
            .chart-container {
                @apply relative w-full aspect-square max-w-md mx-auto my-6;
            }
            .view-toggle-btn {
                @apply px-3 py-1 rounded-lg text-sm font-medium transition-all;
            }
            .view-toggle-btn.active {
                @apply bg-primary text-white;
            }
            .view-toggle-btn.inactive {
                @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
            }
            .task-details-modal {
                @apply fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden;
            }
            .task-details-content {
                @apply bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto;
            }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-light to-blue-50 min-h-screen flex flex-col items-center justify-start p-4 text-dark pt-8">
    <div class="max-w-6xl w-full mx-auto">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="text-center mb-8">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary mb-2 tracking-tight">
                <i class="fa fa-clock-o mr-2"></i>ç»ˆæä¸“æ³¨ç•ªèŒ„é’Ÿ
            </h1>
            <p class="text-gray-600 text-lg">ä¸ªæ€§åŒ–ä¸“æ³¨ä½“éªŒï¼Œæå‡å·¥ä½œæ•ˆç‡</p>
        </div>
        
        <!-- é€šçŸ¥æé†’ -->
        <div id="notification-toast" class="fixed top-4 right-4 bg-primary text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 flex items-center">
            <i class="fa fa-bell mr-2"></i>
            <span id="notification-message"></span>
        </div>
        
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- å·¦ä¾§ï¼šç•ªèŒ„é’Ÿä¸»ä½“ -->
            <div class="xl:col-span-2">
                <div class="bg-white rounded-2xl p-8 timer-shadow transform transition-all duration-500">
                    <!-- å¼€å§‹æŒ‰é’® -->
                    <div class="mb-8 text-center">
                        <button id="start-btn"
                                class="bg-primary text-white px-8 py-4 rounded-lg font-medium btn-hover text-lg">
                            <i class="fa fa-play mr-2"></i>å¼€å§‹ä¸“æ³¨
                        </button>
                    </div>
                    <!-- äº‘åŒæ­¥ -->
                    <div class="mt-8 flex flex-col items-center gap-2">
                        <input id="account" placeholder="è¾“å…¥è´¦å·åŒæ­¥" class="px-3 py-1 border rounded w-40 text-center" />
                        <div class="flex gap-2">
                            <button id="btn-up" class="bg-blue-500 text-white px-4 py-1 rounded">ä¸Šä¼ æ•°æ®</button>
                            <button id="btn-down" class="bg-green-500 text-white px-4 py-1 rounded">ä¸‹è½½æ•°æ®</button>
                        </div>
                    </div>
                    <!-- ä»»åŠ¡è¾“å…¥åŒºåŸŸ -->
                    <div id="task-inputs" class="mb-6">
                        <label for="task-name" class="block text-gray-700 font-medium mb-2">ä»»åŠ¡åç§° <span class="text-danger">*</span></label>
                        <input type="text"
                               id="task-name"
                               placeholder="ä¾‹å¦‚ï¼šå®Œæˆé¡¹ç›®æŠ¥å‘Š"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 input-focus mb-4"
                               required>

                        <label for="task-notes" class="block text-gray-700 font-medium mb-2">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
                        <textarea id="task-notes"
                                  rows="2"
                                  placeholder="æ·»åŠ ä¸€äº›ä»»åŠ¡ç»†èŠ‚æˆ–ç›®æ ‡..."
                                  class="w-full px-4 py-3 rounded-lg border border-gray-300 input-focus mb-6"></textarea>
                    </div>

                    <!-- æ—¶é•¿è®¾ç½®åŒºåŸŸ -->
                    <div id="duration-setup" class="mb-6">
                        <label for="minutes" class="block text-gray-700 font-medium mb-2 text-lg">ä¸“æ³¨æ—¶é•¿ (åˆ†é’Ÿ)</label>
                        <input type="number"
                               id="minutes"
                               min="1"
                               max="180"
                               value="25"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 input-focus text-xl mb-6">
                    </div>

                    <!-- éšæœºä¼‘æ¯æé†’è®¾ç½® -->
                    <div id="break-reminder-setup" class="mb-8 section-divider">
                        <h3 class="text-lg font-semibold text-dark mb-4 flex items-center">
                            <i class="fa fa-random text-accent mr-2"></i>éšæœºä¼‘æ¯æé†’
                        </h3>

                        <!-- ä¼‘æ¯æé†’å¼€å…³ -->
                        <div class="flex items-center justify-between mb-4">
                            <label class="text-gray-700">å¯ç”¨ä¼‘æ¯æé†’</label>
                            <div class="relative inline-block w-12 h-6">
                                <input type="checkbox" id="enable-break-reminder" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-green-400" checked>
                                <label for="enable-break-reminder" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div id="break-settings-container">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="min-break-interval" class="block text-gray-700 mb-1">æœ€å°é—´éš” (åˆ†é’Ÿ)</label>
                                    <input type="number"
                                           id="min-break-interval"
                                           min="0"
                                           max="60"
                                           value="5"
                                           class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                                    <p class="text-xs text-gray-500 mt-1">å¿…é¡»å¤§äºç­‰äº0åˆ†é’Ÿ</p>
                                </div>
                                <div>
                                    <label for="max-break-interval" class="block text-gray-700 mb-1">æœ€å¤§é—´éš” (åˆ†é’Ÿ)</label>
                                    <input type="number"
                                           id="max-break-interval"
                                           min="1"
                                           max="120"
                                           value="10"
                                           class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                                    <p class="text-xs text-gray-500 mt-1">è‡³å°‘1åˆ†é’Ÿï¼Œä¸”å¤§äºæœ€å°é—´éš”</p>
                                </div>
                            </div>

                            <!-- ä¼‘æ¯è¡Œä¸ºè®¾ç½® -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">ä¼‘æ¯è¡Œä¸º</label>

                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-gray-700">éœ€è¦æ‰‹åŠ¨ç»“æŸä¼‘æ¯</label>
                                    <div class="relative inline-block w-12 h-6">
                                        <input type="checkbox" id="manual-break-end" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-green-400" checked>
                                        <label for="manual-break-end" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>

                                <div id="auto-break-duration-container" class="hidden">
                                    <label for="break-duration" class="block text-gray-700 mb-1">è‡ªåŠ¨ä¼‘æ¯æ—¶é•¿ (ç§’)</label>
                                    <input type="number"
                                           id="break-duration"
                                           min="10"
                                           max="300"
                                           value="30"
                                           class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                                    <p class="text-xs text-gray-500 mt-1">ä¼‘æ¯æ—¶é—´ç»“æŸåå°†è‡ªåŠ¨å…³é—­æé†’</p>
                                </div>
                            </div>

                            <p class="text-sm text-gray-500">ç³»ç»Ÿå°†åœ¨è®¾å®šçš„æ—¶é—´èŒƒå›´å†…éšæœºé€‰æ‹©æé†’æ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼Œæç¤ºæ‚¨çŸ­æš‚ä¼‘æ¯</p>
                        </div>
                    </div>

                    <!-- é“ƒå£°è®¾ç½® -->
                    <div id="ringtone-setup" class="mb-8 section-divider">
                        <h3 class="text-lg font-semibold text-dark mb-4 flex items-center">
                            <i class="fa fa-bell text-accent mr-2"></i>é“ƒå£°è®¾ç½®
                        </h3>

                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">ä¸Šä¼ æé†’é“ƒå£°</label>
                            <div class="flex items-center">
                                <input type="file"
                                       id="ringtone-upload"
                                       accept="audio/*"
                                       class="hidden">
                                <label for="ringtone-upload" class="px-4 py-2 border border-gray-300 rounded-l-lg bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors">
                                    <i class="fa fa-upload mr-1"></i>é€‰æ‹©æ–‡ä»¶
                                </label>
                                <span id="ringtone-filename" class="px-4 py-2 border-t border-b border-gray-300 bg-white flex-grow truncate">æœªé€‰æ‹©æ–‡ä»¶</span>
                                <button id="play-ringtone" class="px-4 py-2 border border-gray-300 rounded-r-lg bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors" disabled>
                                    <i class="fa fa-play"></i>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2">å·²ä¿å­˜çš„é“ƒå£°</label>
                            <div id="saved-ringtones" class="max-h-24 overflow-y-auto">
                                <p class="text-sm text-gray-500 italic">æš‚æ— ä¿å­˜çš„é“ƒå£°</p>
                            </div>
                        </div>
                    </div>



                    <!-- å€’è®¡æ—¶æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="timer-display" class="text-center mb-8 hidden">
                        <div class="text-[clamp(3rem,8vw,5rem)] font-bold text-primary mb-2 transition-all duration-300" id="time">25:00</div>
                        <div class="text-gray-500 text-sm" id="status">å‡†å¤‡å°±ç»ª</div>
                        <div class="text-gray-600 mt-2" id="current-task-display"></div>
                        <div class="text-sm text-warning mt-2 hidden" id="next-break-indicator">
                            <i class="fa fa-info-circle mr-1"></i>ä¸‹æ¬¡ä¼‘æ¯æé†’å°†åœ¨çº¦ <span id="next-break-estimate">5</span> åˆ†é’Ÿ
                        </div>
                    </div>

                    <!-- ä¼‘æ¯æé†’å¯¹è¯æ¡† -->
                    <div id="break-reminder-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
                        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
                            <div class="text-5xl text-accent mb-4">
                                <i class="fa fa-coffee"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-dark mb-2">ä¼‘æ¯æ—¶é—´åˆ°ï¼</h3>
                            <p class="text-gray-600 mb-4">çŸ­æš‚ä¼‘æ¯ä¸€ä¸‹ï¼Œæ”¾æ¾çœ¼ç›å’Œå¤§è„‘</p>
                            <div id="break-timer" class="text-xl font-semibold mb-6 hidden">
                                å‰©ä½™: <span id="break-countdown">30</span> ç§’
                            </div>
                            <button id="resume-focus-btn"
                                    class="bg-primary text-white px-6 py-3 rounded-lg font-medium btn-hover">
                                ç»“æŸä¼‘æ¯ï¼Œç»§ç»­ä¸“æ³¨
                            </button>
                            <audio id="reminder-audio" loop></audio>
                        </div>
                    </div>

                    <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
                    <div id="controls" class="flex flex-wrap justify-center gap-4 hidden">
                        <button id="pause-btn"
                                class="bg-accent text-white px-6 py-3 rounded-lg font-medium btn-hover flex items-center">
                            <i class="fa fa-pause mr-2"></i>æš‚åœ
                        </button>
                        <button id="end-early-btn"
                                class="bg-warning text-dark px-6 py-3 rounded-lg font-medium btn-hover flex items-center">
                            <i class="fa fa-flag mr-2"></i>ä¸­é€”ç»“æŸ
                        </button>
                        <button id="reset-btn"
                                class="bg-danger text-white px-6 py-3 rounded-lg font-medium btn-hover flex items-center">
                            <i class="fa fa-refresh mr-2"></i>é‡ç½®
                        </button>
                    </div>

                    <!-- å®Œæˆæç¤ºåŒºåŸŸ -->
                    <div id="complete-message" class="text-center py-6 hidden">
                        <div class="text-5xl text-secondary mb-4">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-secondary mb-2">ä¸“æ³¨æ—¶é—´ç»“æŸï¼</h2>
                        <p class="text-gray-600 mb-4">åšå¾—å¥½ï¼ä¼‘æ¯ä¸€ä¸‹å§</p>

                        <!-- å¤ä¹ è®¾ç½® -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-dark mb-2">è®¾ç½®å¤ä¹ æé†’</h3>
                            <p class="text-sm text-gray-600 mb-3">é€‰æ‹©å¸¸ç”¨å¤ä¹ é—´éš”æˆ–æ‰‹åŠ¨è¾“å…¥ï¼ˆå¤šä¸ªæ—¥æœŸç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼š1,3,7ï¼‰</p>

                            <!-- å¸¸ç”¨å¤ä¹ é—´éš”é€‰æ‹© -->
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button class="review-preset-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover" data-days="1">1å¤©</button>
                                <button class="review-preset-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover" data-days="1,3,7,14,30">1,3,7,14,30å¤©</button>
                                <button class="review-preset-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover" data-days="5,10,20,30">5,10,20,30å¤©</button>
                            </div>

                            <div class="flex">
                                <input type="text"
                                       id="review-days"
                                       placeholder="ä¾‹å¦‚ï¼š1,3,7"
                                       class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 input-focus">
                                <button id="add-review-btn"
                                        class="bg-primary text-white px-4 py-2 rounded-r-lg font-medium btn-hover">
                                    æ·»åŠ 
                                </button>
                            </div>
                        </div>

                        <button id="restart-btn"
                                class="bg-primary text-white px-6 py-3 rounded-lg font-medium btn-hover">
                            å¼€å§‹æ–°çš„ä¸“æ³¨
                        </button>
                    </div>

                    <!-- ä¸­é€”ç»“æŸç¡®è®¤å¯¹è¯æ¡† -->
                    <div id="early-end-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-dark mb-4">ç¡®è®¤ä¸­é€”ç»“æŸï¼Ÿ</h3>
                            <p class="text-gray-600 mb-6">æœ¬æ¬¡ä¸“æ³¨å°†è¢«è®°å½•ä¸ºå·²å®Œæˆï¼Œå®é™…ç”¨æ—¶ä¼šè¢«ä¿å­˜ã€‚</p>
                            <div class="flex gap-4 justify-end">
                                <button id="cancel-end-btn"
                                        class="px-6 py-2 border border-gray-300 rounded-lg font-medium btn-hover">
                                    ç»§ç»­ä¸“æ³¨
                                </button>
                                <button id="confirm-end-btn"
                                        class="px-6 py-2 bg-warning text-dark rounded-lg font-medium btn-hover">
                                    ç¡®è®¤ç»“æŸ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ä¸Šï¼šä»»åŠ¡è®°å½•åŒºåŸŸ -->
            <div class="xl:col-span-1">
                <div class="bg-white rounded-2xl p-6 timer-shadow h-full mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-dark flex items-center">
                            <i class="fa fa-history text-primary mr-2"></i>ä»»åŠ¡è®°å½•
                        </h2>
                        <div class="flex items-center gap-2">
                            <button id="list-view-btn" class="view-toggle-btn active" title="åˆ—è¡¨è§†å›¾">
                                <i class="fa fa-list"></i>
                            </button>
                            <button id="chart-view-btn" class="view-toggle-btn inactive" title="åœ†ç¯è§†å›¾">
                                <i class="fa fa-pie-chart"></i>
                            </button>
                            <button id="add-task-btn" class="text-primary hover:text-primary/80 btn-hover">
                                <i class="fa fa-plus-circle"></i> æ·»åŠ 
                            </button>
                            <!-- æ–°å¢å¯¼å‡ºå¯¼å…¥æŒ‰é’® -->
                            <button id="export-btn" class="text-green-600 hover:text-green-700 btn-hover" title="å¯¼å‡ºæ•°æ®">
                                <i class="fa fa-download"></i>
                            </button>
                            <label for="import-file" class="cursor-pointer text-blue-600 hover:text-blue-700 btn-hover" title="å¯¼å…¥æ•°æ®">
                                <i class="fa fa-upload"></i>
                                <input type="file" id="import-file" accept=".json" class="hidden">
                            </label>
                        </div>
                    </div>

                    <div id="task-filters" class="flex mb-4 gap-2 flex-wrap">
                        <button id="today-filter" class="px-3 py-1 rounded-full bg-primary text-white text-sm btn-hover">ä»Šå¤©</button>
                        <button id="all-filter" class="px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">å…¨éƒ¨</button>
                    </div>

                    <!-- æ—¶é—´èŒƒå›´äºŒçº§ç­›é€‰ -->
                    <div id="date-range-filter" class="mb-6 hidden">
                        <div class="flex gap-2 flex-wrap">
                            <button data-range="day" class="range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">ä»Šæ—¥</button>
                            <button data-range="yesterday" class="range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">æ˜¨å¤©</button>
                            <button data-range="week" class="range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">æœ¬å‘¨</button>
                            <button data-range="lastWeek" class="range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">ä¸Šå‘¨</button>
                            <button data-range="month" class="range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">æœ¬æœˆ</button>
                            <button data-range="custom" class="range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">è‡ªå®šä¹‰</button>
                        </div>

                        <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ -->
                        <div id="custom-date-range" class="mt-3 hidden flex flex-col gap-2">
                            <input type="date" id="start-date" class="w-full px-3 py-1 rounded-lg border border-gray-300 input-focus">
                            <input type="date" id="end-date" class="w-full px-3 py-1 rounded-lg border border-gray-300 input-focus">
                            <button id="apply-date-filter" class="px-3 py-1 bg-primary text-white rounded-lg btn-hover self-end">åº”ç”¨</button>
                        </div>
                    </div>

                    <!-- æ—¶é—´èŒƒå›´æ ‡é¢˜ -->
                    <div id="range-title" class="text-lg font-semibold text-gray-700 mb-4 hidden"></div>

                    <!-- åˆ—è¡¨è§†å›¾å®¹å™¨ -->
                    <div id="task-list-container" class="h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-8" id="no-tasks-message">æš‚æ— ä»»åŠ¡è®°å½•</p>
                        <!-- ä»»åŠ¡è®°å½•å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>

                    <!-- åœ†ç¯è§†å›¾å®¹å™¨ -->
                    <div id="chart-view-container" class="hidden">
                        <div class="chart-container">
                            <canvas id="task-chart"></canvas>
                        </div>
                        <div id="chart-legend" class="max-h-[150px] overflow-y-auto text-sm"></div>
                    </div>
                </div>

                <!-- ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡† -->
                <div id="task-details-modal" class="task-details-modal">
                    <div class="task-details-content">
                        <h3 class="text-xl font-bold text-dark mb-4">ä»»åŠ¡è¯¦æƒ…</h3>
                        <div id="task-details-content">
                            <!-- ä»»åŠ¡è¯¦æƒ…å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button id="close-task-details" class="px-6 py-2 bg-primary text-white rounded-lg font-medium btn-hover">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç¼–è¾‘ä»»åŠ¡å¯¹è¯æ¡† -->
                <div id="edit-task-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold text-dark mb-4">ç¼–è¾‘ä»»åŠ¡</h3>

                        <input type="hidden" id="edit-task-id">

                        <div class="mb-4">
                            <label for="edit-task-name" class="block text-gray-700 font-medium mb-2">ä»»åŠ¡åç§° <span class="text-danger">*</span></label>
                            <input type="text"
                                   id="edit-task-name"
                                   placeholder="è¾“å…¥ä»»åŠ¡åç§°"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="edit-task-planned" class="block text-gray-700 mb-1">è®¡åˆ’æ—¶é•¿ (åˆ†é’Ÿ)</label>
                                <input type="number"
                                       id="edit-task-planned"
                                       min="1"
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                            </div>
                            <div>
                                <label for="edit-task-actual" class="block text-gray-700 mb-1">å®é™…æ—¶é•¿ (åˆ†é’Ÿ)</label>
                                <input type="number"
                                       id="edit-task-actual"
                                       min="1"
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit-task-notes" class="block text-gray-700 font-medium mb-2">å¤‡æ³¨</label>
                            <textarea id="edit-task-notes"
                                      rows="2"
                                      placeholder="æ·»åŠ å¤‡æ³¨..."
                                      class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus"></textarea>
                        </div>

                        <div class="mb-6">
                            <label for="edit-task-date" class="block text-gray-700 font-medium mb-2">å®Œæˆæ—¥æœŸ</label>
                            <input type="datetime-local"
                                   id="edit-task-date"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                        </div>

                        <!-- å¤ä¹ è®¾ç½® -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-dark mb-2">å¤ä¹ è®¡åˆ’</h3>
                            <p class="text-sm text-gray-600 mb-3">å¤šä¸ªæ—¥æœŸç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼š1,3,7ï¼‰</p>

                            <div class="flex">
                                <input type="text"
                                       id="edit-review-days"
                                       placeholder="ä¾‹å¦‚ï¼š1,3,7"
                                       class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 input-focus">
                                <button id="update-review-btn"
                                        class="bg-primary text-white px-4 py-2 rounded-r-lg font-medium btn-hover">
                                    æ›´æ–°
                                </button>
                            </div>
                        </div>

                        <div class="flex gap-4 justify-end">
                            <button id="cancel-edit-task-btn"
                                    class="px-6 py-2 border border-gray-300 rounded-lg font-medium btn-hover">
                                å–æ¶ˆ
                            </button>
                            <button id="confirm-edit-task-btn"
                                    class="px-6 py-2 bg-primary text-white rounded-lg font-medium btn-hover">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ·»åŠ ä»»åŠ¡å¯¹è¯æ¡† -->
                <div id="add-task-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold text-dark mb-4">æ·»åŠ ä»»åŠ¡è®°å½•</h3>

                        <div class="mb-4">
                            <label for="new-task-name" class="block text-gray-700 font-medium mb-2">ä»»åŠ¡åç§° <span class="text-danger">*</span></label>
                            <input type="text"
                                   id="new-task-name"
                                   placeholder="è¾“å…¥ä»»åŠ¡åç§°"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="new-task-planned" class="block text-gray-700 mb-1">è®¡åˆ’æ—¶é•¿ (åˆ†é’Ÿ)</label>
                                <input type="number"
                                       id="new-task-planned"
                                       min="1"
                                       value="25"
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                            </div>
                            <div>
                                <label for="new-task-actual" class="block text-gray-700 mb-1">å®é™…æ—¶é•¿ (åˆ†é’Ÿ)</label>
                                <input type="number"
                                       id="new-task-actual"
                                       min="1"
                                       value="25"
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="new-task-notes" class="block text-gray-700 font-medium mb-2">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
                            <textarea id="new-task-notes"
                                      rows="2"
                                      placeholder="æ·»åŠ å¤‡æ³¨..."
                                      class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus"></textarea>
                        </div>

                        <div class="mb-6">
                            <label for="new-task-date" class="block text-gray-700 font-medium mb-2">å®Œæˆæ—¥æœŸ</label>
                            <input type="datetime-local"
                                   id="new-task-date"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 input-focus">
                        </div>
                        <!-- å¤ä¹ è®¾ç½® -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-dark mb-2">å¤ä¹ è®¡åˆ’ï¼ˆé€‰å¡«ï¼‰</h3>
                            <p class="text-sm text-gray-600 mb-3">é€‰æ‹©å¸¸ç”¨å¤ä¹ é—´éš”æˆ–æ‰‹åŠ¨è¾“å…¥ï¼ˆå¤šä¸ªæ—¥æœŸç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼š1,3,7ï¼‰</p>

                            <!-- å¸¸ç”¨å¤ä¹ é—´éš”é€‰æ‹© -->
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button class="review-preset-btn-new px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover" data-days="1">1å¤©</button>
                                <button class="review-preset-btn-new px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover" data-days="1,3,7,14,30">1,3,7,14,30å¤©</button>
                                <button class="review-preset-btn-new px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover" data-days="5,10,20,30">5,10,20,30å¤©</button>
                            </div>

                            <div class="flex">
                                <input type="text" id="new-review-days" placeholder="ä¾‹å¦‚ï¼š1,3,7" class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 input-focus">
                                <button id="clear-review-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-r-lg btn-hover" title="æ¸…ç©º">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex gap-4 justify-end">
                            <button id="cancel-add-task-btn"
                                    class="px-6 py-2 border border-gray-300 rounded-lg font-medium btn-hover">
                                å–æ¶ˆ
                            </button>
                            <button id="confirm-add-task-btn"
                                    class="px-6 py-2 bg-primary text-white rounded-lg font-medium btn-hover">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åˆ é™¤ä»»åŠ¡ç¡®è®¤å¯¹è¯æ¡† -->
                <div id="delete-task-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold text-dark mb-4">ç¡®è®¤åˆ é™¤ï¼Ÿ</h3>
                        <p class="text-gray-600 mb-6">æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ä»»åŠ¡è®°å½•åŠå…¶ç›¸å…³çš„å¤ä¹ æé†’ã€‚</p>
                        <div class="flex gap-4 justify-end">
                            <button id="cancel-delete-btn"
                                    class="px-6 py-2 border border-gray-300 rounded-lg font-medium btn-hover">
                                å–æ¶ˆ
                            </button>
                            <button id="confirm-delete-btn"
                                    class="px-6 py-2 bg-danger text-white rounded-lg font-medium btn-hover">
                                ç¡®è®¤åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¸‹ï¼šå¤ä¹ è¡¨ -->
            <div class="xl:col-span-1">
                <div class="bg-white rounded-2xl p-6 timer-shadow h-full">
                    <h2 class="text-xl font-bold text-dark mb-4 flex items-center">
                        <i class="fa fa-calendar-check-o text-primary mr-2"></i>å¤ä¹ è¡¨
                    </h2>
                    <a class="btn" href="ack.html">ğŸ§  æ€ç»´å¯¼å›¾</a>

                    <div id="review-filters" class="flex mb-4 gap-2 flex-wrap">
                        <button id="upcoming-filter" class="px-3 py-1 rounded-full bg-primary text-white text-sm btn-hover">å³å°†åˆ°æ¥</button>
                        <button id="all-reviews-filter" class="px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">å…¨éƒ¨</button>
                    </div>

                    <!-- å¤ä¹ è¡¨æ—¶é—´èŒƒå›´äºŒçº§ç­›é€‰ -->
                    <div id="review-date-range-filter" class="mb-6 hidden">
                        <div class="flex gap-2 flex-wrap">
                            <button data-review-range="day" class="review-range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">ä»Šæ—¥</button>
                            <button data-review-range="yesterday" class="review-range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">æ˜¨å¤©</button>
                            <button data-review-range="week" class="review-range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">æœ¬å‘¨</button>
                            <button data-review-range="lastWeek" class="review-range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">ä¸Šå‘¨</button>
                            <button data-review-range="month" class="review-range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">æœ¬æœˆ</button>
                            <button data-review-range="custom" class="review-range-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm btn-hover">è‡ªå®šä¹‰</button>
                        </div>

                        <div id="review-custom-date-range" class="mt-3 hidden flex flex-col gap-2">
                            <input type="date" id="review-start-date" class="w-full px-3 py-1 rounded-lg border border-gray-300 input-focus">
                            <input type="date" id="review-end-date" class="w-full px-3 py-1 rounded-lg border border-gray-300 input-focus">
                            <button id="apply-review-filter" class="px-3 py-1 bg-primary text-white rounded-lg btn-hover self-end">åº”ç”¨</button>
                        </div>
                    </div>

                    <!-- å¤ä¹ è¡¨æ—¶é—´èŒƒå›´æ ‡é¢˜ -->
                    <div id="review-range-title" class="text-lg font-semibold text-gray-700 mb-4 hidden"></div>

                    <div id="review-list" class="h-96 overflow-y-auto pr-2"></div>
                    <p class="text-gray-500 text-center py-8" id="no-reviews-message">æš‚æ— å¤ä¹ è®¡åˆ’</p>
                    <!-- å¤ä¹ è®°å½•å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
        </div>
        </div>
        
        <!-- ä¿¡æ¯æç¤º -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>æç¤ºï¼šé€‚å½“ä¼‘æ¯å’Œå®šæœŸå¤ä¹ æœ‰åŠ©äºæé«˜å­¦ä¹ å’Œå·¥ä½œæ•ˆç‡</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        // è·å–DOMå…ƒç´ 
        const taskNameInput = document.getElementById('task-name');
        const taskNotesInput = document.getElementById('task-notes');
        const minutesInput = document.getElementById('minutes');
        const minBreakIntervalInput = document.getElementById('min-break-interval');
        const maxBreakIntervalInput = document.getElementById('max-break-interval');
        const enableBreakReminderCheckbox = document.getElementById('enable-break-reminder');
        const manualBreakEndCheckbox = document.getElementById('manual-break-end');
        const autoBreakDurationContainer = document.getElementById('auto-break-duration-container');
        const breakDurationInput = document.getElementById('break-duration');
        const breakSettingsContainer = document.getElementById('break-settings-container');
        const ringtoneUploadInput = document.getElementById('ringtone-upload');
        const ringtoneFilenameDisplay = document.getElementById('ringtone-filename');
        const playRingtoneBtn = document.getElementById('play-ringtone');
        const savedRingtonesContainer = document.getElementById('saved-ringtones');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const restartBtn = document.getElementById('restart-btn');
        const endEarlyBtn = document.getElementById('end-early-btn');
        const cancelEndBtn = document.getElementById('cancel-end-btn');
        const confirmEndBtn = document.getElementById('confirm-end-btn');
        const earlyEndModal = document.getElementById('early-end-modal');
        const timeDisplay = document.getElementById('time');
        const statusDisplay = document.getElementById('status');
        const currentTaskDisplay = document.getElementById('current-task-display');
        const nextBreakIndicator = document.getElementById('next-break-indicator');
        const nextBreakEstimate = document.getElementById('next-break-estimate');
        const durationSetup = document.getElementById('duration-setup');
        const breakReminderSetup = document.getElementById('break-reminder-setup');
        const ringtoneSetup = document.getElementById('ringtone-setup');
        const taskInputs = document.getElementById('task-inputs');
        const controls = document.getElementById('controls');
        const timerDisplay = document.getElementById('timer-display');
        const completeMessage = document.getElementById('complete-message');
        const taskListContainer = document.getElementById('task-list-container');
        const noTasksMessage = document.getElementById('no-tasks-message');
        const todayFilter = document.getElementById('today-filter');
        const allFilter = document.getElementById('all-filter');
        const dateRangeFilter = document.getElementById('date-range-filter');
        const rangeTitle = document.getElementById('range-title');
        const rangeButtons = document.querySelectorAll('.range-btn');
        const customDateRange = document.getElementById('custom-date-range');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyDateFilterBtn = document.getElementById('apply-date-filter');
        const breakReminderModal = document.getElementById('break-reminder-modal');
        const resumeFocusBtn = document.getElementById('resume-focus-btn');
        const reminderAudio = document.getElementById('reminder-audio');
        const breakTimerDisplay = document.getElementById('break-timer');
        const breakCountdownDisplay = document.getElementById('break-countdown');
        const reviewDaysInput = document.getElementById('review-days');
        const addReviewBtn = document.getElementById('add-review-btn');
        const addTaskBtn = document.getElementById('add-task-btn');
        const addTaskModal = document.getElementById('add-task-modal');
        const cancelAddTaskBtn = document.getElementById('cancel-add-task-btn');
        const confirmAddTaskBtn = document.getElementById('confirm-add-task-btn');
        const newTaskNameInput = document.getElementById('new-task-name');
        const newTaskPlannedInput = document.getElementById('new-task-planned');
        const newTaskActualInput = document.getElementById('new-task-actual');
        const newTaskNotesInput = document.getElementById('new-task-notes');
        const newTaskDateInput = document.getElementById('new-task-date');
        const deleteTaskModal = document.getElementById('delete-task-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const reviewList = document.getElementById('review-list');
        const noReviewsMessage = document.getElementById('no-reviews-message');
        const upcomingFilter = document.getElementById('upcoming-filter');
        const allReviewsFilter = document.getElementById('all-reviews-filter');
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        const reviewPresetBtns = document.querySelectorAll('.review-preset-btn');
        const reviewDateRangeFilter = document.getElementById('review-date-range-filter');
        const reviewRangeTitle = document.getElementById('review-range-title');
        const reviewRangeButtons = document.querySelectorAll('.review-range-btn');
        const reviewCustomDateRange = document.getElementById('review-custom-date-range');
        const reviewStartDateInput = document.getElementById('review-start-date');
        const reviewEndDateInput = document.getElementById('review-end-date');
        const applyReviewFilterBtn = document.getElementById('apply-review-filter');
        const editTaskModal = document.getElementById('edit-task-modal');
        const editTaskIdInput = document.getElementById('edit-task-id');
        const editTaskNameInput = document.getElementById('edit-task-name');
        const editTaskPlannedInput = document.getElementById('edit-task-planned');
        const editTaskActualInput = document.getElementById('edit-task-actual');
        const editTaskNotesInput = document.getElementById('edit-task-notes');
        const editTaskDateInput = document.getElementById('edit-task-date');
        const editReviewDaysInput = document.getElementById('edit-review-days');
        const updateReviewBtn = document.getElementById('update-review-btn');
        const cancelEditTaskBtn = document.getElementById('cancel-edit-task-btn');
        const confirmEditTaskBtn = document.getElementById('confirm-edit-task-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const chartViewBtn = document.getElementById('chart-view-btn');
        const taskListContainerEl = document.getElementById('task-list-container');
        const chartViewContainer = document.getElementById('chart-view-container');
        const taskChart = document.getElementById('task-chart');
        const chartLegend = document.getElementById('chart-legend');
        const taskDetailsModal = document.getElementById('task-details-modal');
        const taskDetailsContent = document.getElementById('task-details-content');
        const closeTaskDetails = document.getElementById('close-task-details');
        // è·å–DOMå…ƒç´ 
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file');
        
        // å›¾è¡¨å®ä¾‹
        let taskChartInstance = null;
        
        // å®šæ—¶å™¨å˜é‡
        let mainTimer;           // ä¸»ä¸“æ³¨è®¡æ—¶å™¨
        let breakTimer;          // ä¼‘æ¯æé†’è®¡æ—¶å™¨
        let autoBreakTimer;      // è‡ªåŠ¨ä¼‘æ¯è®¡æ—¶å™¨
        let totalSeconds;        // ä¸»è®¡æ—¶å™¨æ€»ç§’æ•°
        let originalDuration;    // è®°å½•åŸå§‹è®¾ç½®çš„æ—¶é•¿
        let minBreakInterval;    // æœ€å°ä¼‘æ¯é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        let maxBreakInterval;    // æœ€å¤§ä¼‘æ¯é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        let nextBreakTime;       // ä¸‹æ¬¡ä¼‘æ¯æ—¶é—´ï¼ˆç§’ï¼‰
        let currentTaskId;       // å½“å‰ä»»åŠ¡ID
        let tasks = [];          // ä»»åŠ¡è®°å½•æ•°ç»„
        let reviews = [];        // å¤ä¹ è®°å½•æ•°ç»„
        let currentFilter = 'today'; // å½“å‰ä»»åŠ¡ç­›é€‰æ¡ä»¶
        let currentReviewFilter = 'upcoming'; // å½“å‰å¤ä¹ ç­›é€‰æ¡ä»¶
        let currentRange = 'day'; // å½“å‰æ—¶é—´èŒƒå›´
        let currentReviewRange = 'day'; // å½“å‰å¤ä¹ æ—¶é—´èŒƒå›´
        let customDateFilter = { start: null, end: null }; // è‡ªå®šä¹‰æ—¥æœŸç­›é€‰
        let customReviewFilter = { start: null, end: null }; // è‡ªå®šä¹‰å¤ä¹ ç­›é€‰
        let currentView = 'list'; // å½“å‰è§†å›¾æ¨¡å¼ï¼šlist æˆ– chart
        
        
        // åˆå§‹åŒ–
        function init() {
            // è®¾ç½®å½“å‰æ—¥æœŸæ—¶é—´
            const now = new Date();
            newTaskDateInput.value = formatDateTimeLocal(now);
            startDateInput.valueAsDate = new Date(now.setDate(now.getDate() - 7));
            endDateInput.valueAsDate = new Date();
            reviewStartDateInput.valueAsDate = new Date(now.setDate(now.getDate() - 7));
            reviewEndDateInput.valueAsDate = new Date();
            // ç»‘å®šäº‹ä»¶
            exportBtn.addEventListener('click', exportData);
            importFileInput.addEventListener('change', importData);
            // ä»localStorageåŠ è½½æ•°æ®
            loadData();
            
            // æ¸²æŸ“ä»»åŠ¡å’Œå¤ä¹ è®°å½•
            renderTasks();
            renderReviews();
            
            // äº‹ä»¶ç›‘å¬
            setupEventListeners();
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // ä¼‘æ¯æé†’å¼€å…³
            enableBreakReminderCheckbox.addEventListener('change', toggleBreakSettings);
            
            // æ‰‹åŠ¨ç»“æŸä¼‘æ¯å¼€å…³
            manualBreakEndCheckbox.addEventListener('change', toggleAutoBreakDuration);
            
            // é“ƒå£°ä¸Šä¼ 
            ringtoneUploadInput.addEventListener('change', handleRingtoneUpload);
            playRingtoneBtn.addEventListener('click', playRingtone);
            
            // å¼€å§‹æŒ‰é’®
            startBtn.addEventListener('click', startTimer);
            
            // æš‚åœæŒ‰é’®
            pauseBtn.addEventListener('click', pauseTimer);
            
            // é‡ç½®æŒ‰é’®
            resetBtn.addEventListener('click', resetTimer);
            
            // é‡æ–°å¼€å§‹æŒ‰é’®
            restartBtn.addEventListener('click', restartTimer);
            
            // ä¸­é€”ç»“æŸæŒ‰é’®
            endEarlyBtn.addEventListener('click', () => {
                earlyEndModal.classList.remove('hidden');
            });
            
            // å–æ¶ˆä¸­é€”ç»“æŸ
            cancelEndBtn.addEventListener('click', () => {
                earlyEndModal.classList.add('hidden');
            });
            
            // ç¡®è®¤ä¸­é€”ç»“æŸ
            confirmEndBtn.addEventListener('click', completeTimerEarly);
            
            // ç»“æŸä¼‘æ¯
            resumeFocusBtn.addEventListener('click', endBreak);
            
            // æ·»åŠ å¤ä¹ è®¡åˆ’
            addReviewBtn.addEventListener('click', addReviewPlans);
            
            // å¤ä¹ é—´éš”é¢„è®¾æŒ‰é’®
            reviewPresetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    reviewDaysInput.value = btn.dataset.days;
                });
            });
            
            // æ·»åŠ ä»»åŠ¡æŒ‰é’®
            addTaskBtn.addEventListener('click', () => {
                newTaskNameInput.value = '';
                newTaskPlannedInput.value = 25;
                newTaskActualInput.value = 25;
                newTaskNotesInput.value = '';
                newTaskDateInput.value = formatDateTimeLocal(new Date());
                addTaskModal.classList.remove('hidden');
            });
            
            // å–æ¶ˆæ·»åŠ ä»»åŠ¡
            cancelAddTaskBtn.addEventListener('click', () => {
                addTaskModal.classList.add('hidden');
            });
            
            // ç¡®è®¤æ·»åŠ ä»»åŠ¡
            confirmAddTaskBtn.addEventListener('click', addNewTask);
            // å¤ä¹ è®¡åˆ’é¢„è®¾æŒ‰é’®ï¼ˆæ·»åŠ ä»»åŠ¡å¯¹è¯æ¡†ï¼‰
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('review-preset-btn-new')) {
                    document.getElementById('new-review-days').value = e.target.dataset.days;
                }
            });

            // æ¸…ç©ºå¤ä¹ è®¡åˆ’æŒ‰é’®
            document.getElementById('clear-review-btn').addEventListener('click', function () {
                document.getElementById('new-review-days').value = '';
            });
            
            // å–æ¶ˆåˆ é™¤ä»»åŠ¡
            cancelDeleteBtn.addEventListener('click', () => {
                deleteTaskModal.classList.add('hidden');
            });
            
            // ç¡®è®¤åˆ é™¤ä»»åŠ¡
            confirmDeleteBtn.addEventListener('click', confirmDeleteTask);
            
            // ä»»åŠ¡ç­›é€‰
            todayFilter.addEventListener('click', () => {
                currentFilter = 'today';
                updateTaskFilters();
                renderTasks();
            });
            
            allFilter.addEventListener('click', () => {
                currentFilter = 'all';
                updateTaskFilters();
                renderTasks();
            });
            
            // æ—¶é—´èŒƒå›´ç­›é€‰
            rangeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentRange = btn.dataset.range;
                    updateRangeButtons();
                    
                    if (currentRange === 'custom') {
                        customDateRange.classList.remove('hidden');
                    } else {
                        customDateRange.classList.add('hidden');
                        renderTasks();
                    }
                });
            });
            
            // åº”ç”¨è‡ªå®šä¹‰æ—¥æœŸç­›é€‰
            applyDateFilterBtn.addEventListener('click', () => {
                if (startDateInput.value && endDateInput.value) {
                    customDateFilter.start = new Date(startDateInput.value);
                    customDateFilter.end = new Date(endDateInput.value);
                    customDateFilter.end.setHours(23, 59, 59, 999);
                    renderTasks();
                } else {
                    showNotification('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                }
            });
            
            // å¤ä¹ ç­›é€‰
            upcomingFilter.addEventListener('click', () => {
                currentReviewFilter = 'upcoming';
                updateReviewFilters();
                renderReviews();
            });
            
            allReviewsFilter.addEventListener('click', () => {
                currentReviewFilter = 'all';
                updateReviewFilters();
                renderReviews();
            });
            
            // å¤ä¹ æ—¶é—´èŒƒå›´ç­›é€‰
            reviewRangeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentReviewRange = btn.dataset.reviewRange;
                    updateReviewRangeButtons();
                    
                    if (currentReviewRange === 'custom') {
                        reviewCustomDateRange.classList.remove('hidden');
                    } else {
                        reviewCustomDateRange.classList.add('hidden');
                        renderReviews();
                    }
                });
            });
            
            // åº”ç”¨è‡ªå®šä¹‰å¤ä¹ æ—¥æœŸç­›é€‰
            applyReviewFilterBtn.addEventListener('click', () => {
                if (reviewStartDateInput.value && reviewEndDateInput.value) {
                    customReviewFilter.start = new Date(reviewStartDateInput.value);
                    customReviewFilter.end = new Date(reviewEndDateInput.value);
                    customReviewFilter.end.setHours(23, 59, 59, 999);
                    renderReviews();
                } else {
                    showNotification('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                }
            });
            
            // ç¼–è¾‘ä»»åŠ¡ç›¸å…³
            cancelEditTaskBtn.addEventListener('click', () => {
                editTaskModal.classList.add('hidden');
            });
            
            confirmEditTaskBtn.addEventListener('click', saveEditedTask);
            updateReviewBtn.addEventListener('click', updateReviewPlans);
            
            // è§†å›¾åˆ‡æ¢
            listViewBtn.addEventListener('click', function() {
                if (currentView !== 'list') {
                    currentView = 'list';
                    updateViewButtons();
                    renderTasks();
                }
            });
            
            chartViewBtn.addEventListener('click', function() {
                if (currentView !== 'chart') {
                    currentView = 'chart';
                    updateViewButtons();
                    renderTasks();
                }
            });
            
            // å…³é—­ä»»åŠ¡è¯¦æƒ…
            closeTaskDetails.addEventListener('click', () => {
                taskDetailsModal.classList.add('hidden');
            });
        }
        
        // æ›´æ–°è§†å›¾æŒ‰é’®æ ·å¼
        function updateViewButtons() {
            if (currentView === 'list') {
                listViewBtn.classList.add('active');
                listViewBtn.classList.remove('inactive');
                chartViewBtn.classList.add('inactive');
                chartViewBtn.classList.remove('active');
                taskListContainerEl.classList.remove('hidden');
                chartViewContainer.classList.add('hidden');
            } else {
                listViewBtn.classList.add('inactive');
                listViewBtn.classList.remove('active');
                chartViewBtn.classList.add('active');
                chartViewBtn.classList.remove('inactive');
                taskListContainerEl.classList.add('hidden');
                chartViewContainer.classList.remove('hidden');
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºdatetime-localæ ¼å¼
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
        function loadData() {
            const savedTasks = localStorage.getItem('pomodoroTasks');
            const savedReviews = localStorage.getItem('pomodoroReviews');
            
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            
            if (savedReviews) {
                reviews = JSON.parse(savedReviews);
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            localStorage.setItem('pomodoroTasks', JSON.stringify(tasks));
            localStorage.setItem('pomodoroReviews', JSON.stringify(reviews));
        }
        
        // åˆ‡æ¢ä¼‘æ¯è®¾ç½®æ˜¾ç¤º
        function toggleBreakSettings() {
            if (enableBreakReminderCheckbox.checked) {
                breakSettingsContainer.classList.remove('hidden');
            } else {
                breakSettingsContainer.classList.add('hidden');
            }
        }
        
        // åˆ‡æ¢è‡ªåŠ¨ä¼‘æ¯æ—¶é•¿æ˜¾ç¤º
        function toggleAutoBreakDuration() {
            if (manualBreakEndCheckbox.checked) {
                autoBreakDurationContainer.classList.add('hidden');
                breakTimerDisplay.classList.add('hidden');
            } else {
                autoBreakDurationContainer.classList.remove('hidden');
                breakTimerDisplay.classList.remove('hidden');
            }
        }
        
        // å¤„ç†é“ƒå£°ä¸Šä¼ 
        function handleRingtoneUpload(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                ringtoneFilenameDisplay.textContent = file.name;
                playRingtoneBtn.disabled = false;
                
                // è¯»å–æ–‡ä»¶å¹¶è®¾ç½®ä¸ºæé†’é“ƒå£°
                const reader = new FileReader();
                reader.onload = function(event) {
                    reminderAudio.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // æ’­æ”¾é“ƒå£°
        function playRingtone() {
            if (reminderAudio.src) {
                reminderAudio.play().catch(error => {
                    console.error('æ’­æ”¾é“ƒå£°å¤±è´¥:', error);
                    showNotification('æ’­æ”¾é“ƒå£°å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶');
                });
            }
        }
        
        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            // éªŒè¯ä»»åŠ¡åç§°
            if (!taskNameInput.value.trim()) {
                showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                taskNameInput.focus();
                return;
            }
            
            // éªŒè¯ä¼‘æ¯é—´éš”
            if (enableBreakReminderCheckbox.checked) {
                const min = parseInt(minBreakIntervalInput.value);
                const max = parseInt(maxBreakIntervalInput.value);
                
                if (min < 0 || max < 1 || max <= min) {
                    showNotification('è¯·è®¾ç½®æœ‰æ•ˆçš„ä¼‘æ¯é—´éš”');
                    return;
                }
                
                // âœ… æ–°ä»£ç ï¼ˆåŒºé—´å†…ä»»æ„ä¸€ç§’ï¼‰
                const minSeconds = min * 60;
                const maxSeconds = max * 60;
                nextBreakTime = Math.floor(Math.random() * (maxSeconds - minSeconds + 1)) + minSeconds;
                nextBreakEstimate.textContent = Math.round(nextBreakTime / 60);
                nextBreakIndicator.classList.remove('hidden');
            }
            
            // éšè—è®¾ç½®åŒºåŸŸï¼Œæ˜¾ç¤ºè®¡æ—¶å™¨
            durationSetup.classList.add('hidden');
            if (enableBreakReminderCheckbox.checked) {
                breakReminderSetup.classList.add('hidden');
            }
            ringtoneSetup.classList.add('hidden');
            taskInputs.classList.add('hidden');
            startBtn.classList.add('hidden');
            timerDisplay.classList.remove('hidden');
            controls.classList.remove('hidden');
            
            // è®¾ç½®æ€»ç§’æ•°
            const minutes = parseInt(minutesInput.value);
            totalSeconds = minutes * 60;
            originalDuration = totalSeconds;
            
            // æ˜¾ç¤ºå½“å‰ä»»åŠ¡
            currentTaskDisplay.textContent = taskNameInput.value;
            
            // æ›´æ–°æ˜¾ç¤º
            updateTimerDisplay();
            statusDisplay.textContent = 'ä¸“æ³¨ä¸­...';
            
            // å¯åŠ¨ä¸»è®¡æ—¶å™¨
            clearInterval(mainTimer);
            mainTimer = setInterval(updateMainTimer, 1000);
            
            // å¦‚æœå¯ç”¨äº†ä¼‘æ¯æé†’ï¼Œå¯åŠ¨ä¼‘æ¯è®¡æ—¶å™¨
            if (enableBreakReminderCheckbox.checked) {
                clearInterval(breakTimer);
                breakTimer = setInterval(checkBreakTime, 1000);
            }
        }
        
        // æ›´æ–°ä¸»è®¡æ—¶å™¨
        function updateMainTimer() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateTimerDisplay();
            } else {
                completeTimer();
            }
        }
        
        // æ£€æŸ¥ä¼‘æ¯æ—¶é—´
        function checkBreakTime() {
            if (nextBreakTime > 0) {
                nextBreakTime--;
                nextBreakEstimate.textContent = Math.round(nextBreakTime / 60);
            } else {
                clearInterval(breakTimer); // âœ… åŠ åœ¨è¿™é‡Œ
                triggerBreakReminder();
            }
        }
        
        // è§¦å‘ä¼‘æ¯æé†’
        // è§¦å‘ä¼‘æ¯æé†’
        function triggerBreakReminder() {
            // æš‚åœä¸»è®¡æ—¶å™¨
            clearInterval(mainTimer);

            // âœ… åœ¨è¿™é‡ŒåŠ ä¸€è¡Œæ—¥å¿—
            console.log("ğŸŸ¢ triggerBreakReminder è§¦å‘ï¼Œmanual-break-end.checked =", manualBreakEndCheckbox.checked);

            // æ˜¾ç¤ºä¼‘æ¯æé†’
            breakReminderModal.classList.remove('hidden');

            // æ’­æ”¾æé†’é“ƒå£°
            if (reminderAudio.src) {
                reminderAudio.play().catch(error => {
                    console.error('æ’­æ”¾æé†’é“ƒå£°å¤±è´¥:', error);
                });
            }

            // å¦‚æœä¸éœ€è¦æ‰‹åŠ¨ç»“æŸï¼Œå¯åŠ¨è‡ªåŠ¨ä¼‘æ¯è®¡æ—¶å™¨
            if (!manualBreakEndCheckbox.checked) {
                let remaining = parseInt(breakDurationInput.value);
                console.log("ğŸŸ¢ è¿›å…¥è‡ªåŠ¨å€’è®¡æ—¶é€»è¾‘ï¼Œå‰©ä½™ç§’æ•°:", remaining);

                breakCountdownDisplay.textContent = remaining;
                breakTimerDisplay.classList.remove('hidden');

                clearInterval(autoBreakTimer);
                autoBreakTimer = setInterval(() => {
                    remaining -= 1;
                    breakCountdownDisplay.textContent = remaining;
                    if (remaining <= 0) {
                        clearInterval(autoBreakTimer);
                        endBreak();
                    }
                }, 1000);
            }
        }
        
        // ç»“æŸä¼‘æ¯
        function endBreak() {
            // éšè—ä¼‘æ¯æé†’

            breakReminderModal.classList.add('hidden');
            
            // åœæ­¢é“ƒå£°
            reminderAudio.pause();
            reminderAudio.currentTime = 0;
            
            // æ¸…é™¤è‡ªåŠ¨ä¼‘æ¯è®¡æ—¶å™¨
            clearInterval(autoBreakTimer);
            
            // é‡æ–°å¯åŠ¨ä¸»è®¡æ—¶å™¨
            mainTimer = setInterval(updateMainTimer, 1000);
            statusDisplay.textContent = 'ä¸“æ³¨ä¸­...';
            
            // å¦‚æœå¯ç”¨äº†ä¼‘æ¯æé†’ï¼Œé‡æ–°ç”Ÿæˆä¸‹æ¬¡ä¼‘æ¯æ—¶é—´
            if (enableBreakReminderCheckbox.checked) {
                const min = parseInt(minBreakIntervalInput.value);
                const max = parseInt(maxBreakIntervalInput.value);
                nextBreakTime = Math.floor(Math.random() * (max - min + 1) + min) * 60;
                nextBreakEstimate.textContent = Math.round(nextBreakTime / 60);
                clearInterval(breakTimer);
                breakTimer = setInterval(checkBreakTime, 1000);
            }
        }
        
        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ·»åŠ è¿›åº¦æ•ˆæœ
            const progress = 1 - (totalSeconds / originalDuration);
            timeDisplay.style.transform = `scale(${1 + progress * 0.1})`;
            timeDisplay.style.color = `hsl(${217 - progress * 120}, 91%, 59%)`;
        }
        
        // æš‚åœè®¡æ—¶å™¨
        function pauseTimer() {
            clearInterval(mainTimer);
            clearInterval(breakTimer);
            statusDisplay.textContent = 'å·²æš‚åœ';
            pauseBtn.innerHTML = '<i class="fa fa-play mr-2"></i>ç»§ç»­';
            pauseBtn.removeEventListener('click', pauseTimer);
            pauseBtn.addEventListener('click', resumeTimer);
        }
        
        // æ¢å¤è®¡æ—¶å™¨
        function resumeTimer() {
            mainTimer = setInterval(updateMainTimer, 1000);

            // âœ… æ­£ç¡®æ¢å¤ä¼‘æ¯æé†’è®¡æ—¶å™¨
            if (enableBreakReminderCheckbox.checked) {
                clearInterval(breakTimer); // é˜²æ­¢é‡å¤
                breakTimer = setInterval(checkBreakTime, 1000);
            }

            statusDisplay.textContent = 'ä¸“æ³¨ä¸­...';
            pauseBtn.innerHTML = '<i class="fa fa-pause mr-2"></i>æš‚åœ';
            pauseBtn.removeEventListener('click', resumeTimer);
            pauseBtn.addEventListener('click', pauseTimer);
        }
        
        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            clearInterval(mainTimer);
            clearInterval(breakTimer);
            clearInterval(autoBreakTimer);
            
            // æ˜¾ç¤ºè®¾ç½®åŒºåŸŸï¼Œéšè—è®¡æ—¶å™¨
            durationSetup.classList.remove('hidden');
            if (enableBreakReminderCheckbox.checked) {
                breakReminderSetup.classList.remove('hidden');
            }
            ringtoneSetup.classList.remove('hidden');
            taskInputs.classList.remove('hidden');
            startBtn.classList.remove('hidden');
            timerDisplay.classList.add('hidden');
            controls.classList.add('hidden');
            completeMessage.classList.add('hidden');
            nextBreakIndicator.classList.add('hidden');
            breakReminderModal.classList.add('hidden');
            
            // é‡ç½®é“ƒå£°
            reminderAudio.pause();
            reminderAudio.currentTime = 0;
            
            // é‡ç½®æš‚åœæŒ‰é’®
            pauseBtn.innerHTML = '<i class="fa fa-pause mr-2"></i>æš‚åœ';
            pauseBtn.removeEventListener('click', resumeTimer);
            pauseBtn.addEventListener('click', pauseTimer);
        }
        
        // é‡æ–°å¼€å§‹è®¡æ—¶å™¨
        function restartTimer() {
            resetTimer();
            taskNameInput.value = '';
            taskNotesInput.value = '';
            minutesInput.value = 25;
            reviewDaysInput.value = '';
        }
        
        // å®Œæˆè®¡æ—¶å™¨ï¼ˆæ­£å¸¸ç»“æŸï¼‰
        function completeTimer() {
            completeTimerProcess(originalDuration);
        }
        
        // æå‰å®Œæˆè®¡æ—¶å™¨
        function completeTimerEarly() {
            earlyEndModal.classList.add('hidden');
            completeTimerProcess(originalDuration - totalSeconds);
        }
        
        // è®¡æ—¶å™¨å®Œæˆå¤„ç†
        function completeTimerProcess(actualSeconds) {
            clearInterval(mainTimer);
            clearInterval(breakTimer);
            clearInterval(autoBreakTimer);
            
            // æ’­æ”¾å®Œæˆæç¤ºéŸ³
            if (reminderAudio.src) {
                reminderAudio.play().catch(error => {
                    console.error('æ’­æ”¾å®Œæˆæç¤ºéŸ³å¤±è´¥:', error);
                });
            }
            
            // éšè—æ§åˆ¶æŒ‰é’®ï¼Œæ˜¾ç¤ºå®Œæˆä¿¡æ¯
            controls.classList.add('hidden');
            completeMessage.classList.remove('hidden');
            statusDisplay.textContent = 'å·²å®Œæˆ';
            
            // ä¿å­˜ä»»åŠ¡è®°å½•
            const task = {
                id: Date.now().toString(),
                name: taskNameInput.value,
                notes: taskNotesInput.value,
                plannedMinutes: parseInt(minutesInput.value),
                actualMinutes: Math.round(actualSeconds / 60),
                completedAt: new Date().toISOString()
            };
            
            tasks.unshift(task);
            currentTaskId = task.id;
            saveData();
            renderTasks();
        }
        
        // æ·»åŠ å¤ä¹ è®¡åˆ’
        function addReviewPlans() {
            if (!reviewDaysInput.value.trim()) {
                showNotification('è¯·è¾“å…¥å¤ä¹ é—´éš”');
                return;
            }
            
            if (!currentTaskId) {
                showNotification('æ²¡æœ‰æ‰¾åˆ°å½“å‰ä»»åŠ¡');
                return;
            }
            
            const daysArray = reviewDaysInput.value.split(',').map(day => parseInt(day.trim())).filter(day => !isNaN(day) && day > 0);
            
            if (daysArray.length === 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤ä¹ é—´éš”ï¼ˆæ­£æ•°ï¼‰');
                return;
            }
            
            // æ‰¾åˆ°å½“å‰ä»»åŠ¡
            const task = tasks.find(t => t.id === currentTaskId);
            if (!task) {
                showNotification('æ²¡æœ‰æ‰¾åˆ°å½“å‰ä»»åŠ¡');
                return;
            }
            
            // æ·»åŠ å¤ä¹ è®¡åˆ’
            daysArray.forEach(days => {
                const reviewDate = new Date(task.completedAt);
                reviewDate.setDate(reviewDate.getDate() + days);
                
                const review = {
                    id: Date.now().toString() + '-' + days,
                    taskId: currentTaskId,
                    taskName: task.name,
                    taskNotes: task.notes,
                    daysLater: days,
                    reviewDate: reviewDate.toISOString(),
                    completed: false
                };
                
                reviews.push(review);
            });
            
            saveData();
            renderReviews();
            showNotification(`å·²æ·»åŠ  ${daysArray.length} ä¸ªå¤ä¹ è®¡åˆ’`);
            reviewDaysInput.value = '';
        }
        
        // æ›´æ–°å¤ä¹ è®¡åˆ’
        function updateReviewPlans() {
            const taskId = editTaskIdInput.value;
            if (!taskId) {
                showNotification('æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡');
                return;
            }
            
            // éªŒè¯è¾“å…¥
            if (!editReviewDaysInput.value.trim()) {
                showNotification('è¯·è¾“å…¥å¤ä¹ é—´éš”');
                return;
            }
            
            // è§£æå¤©æ•°
            const daysArray = editReviewDaysInput.value.split(',').map(day => parseInt(day.trim())).filter(day => !isNaN(day) && day > 0);
            
            if (daysArray.length === 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤ä¹ é—´éš”ï¼ˆæ­£æ•°ï¼‰');
                return;
            }
            
            // å…ˆåˆ é™¤è¯¥ä»»åŠ¡çš„æ‰€æœ‰å¤ä¹ è®¡åˆ’
            reviews = reviews.filter(review => review.taskId !== taskId);
            
            // æ‰¾åˆ°ä»»åŠ¡
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                showNotification('æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡');
                return;
            }
            
            // æ·»åŠ æ–°çš„å¤ä¹ è®¡åˆ’
            daysArray.forEach(days => {
                const reviewDate = new Date(task.completedAt);
                reviewDate.setDate(reviewDate.getDate() + days);
                
                const review = {
                    id: Date.now().toString() + '-' + days + '-' + taskId,
                    taskId: taskId,
                    taskName: task.name,
                    taskNotes: task.notes,
                    daysLater: days,
                    reviewDate: reviewDate.toISOString(),
                    completed: false
                };
                
                reviews.push(review);
            });
            
            saveData();
            renderReviews();
            showNotification(`å·²æ›´æ–°ä¸º ${daysArray.length} ä¸ªå¤ä¹ è®¡åˆ’`);
        }
        
        // æ¸²æŸ“ä»»åŠ¡è®°å½•
        function renderTasks() {
            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤ä»»åŠ¡
            let filteredTasks = [...tasks];
            
            if (currentFilter === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                filteredTasks = filteredTasks.filter(task => {
                    const taskDate = new Date(task.completedAt);
                    return taskDate >= today && taskDate < tomorrow;
                });
                
                rangeTitle.textContent = 'ä»Šæ—¥ä»»åŠ¡';
                rangeTitle.classList.remove('hidden');
            } else if (currentFilter === 'all') {
                dateRangeFilter.classList.remove('hidden');
                
                if (currentRange === 'day') {
                    // ä»…ä»Šå¤©
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.completedAt);
                        return taskDate >= today && taskDate < tomorrow;
                    });
                    
                    rangeTitle.textContent = 'ä»Šæ—¥ä»»åŠ¡';
                } else if (currentRange === 'week') {
                    // æœ¬å‘¨ï¼ˆä»å‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
                    const now = new Date();
                    const dayOfWeek = now.getDay() || 7; // è®©å‘¨æ—¥ä¸º7è€Œä¸æ˜¯0
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - (dayOfWeek - 1));
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.completedAt);
                        return taskDate >= startOfWeek && taskDate <= endOfWeek;
                    });
                    
                    rangeTitle.textContent = 'æœ¬å‘¨ä»»åŠ¡';
                } else if (currentRange === 'month') {
                    // æœ¬æœˆ
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endOfMonth.setHours(23, 59, 59, 999);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.completedAt);
                        return taskDate >= startOfMonth && taskDate <= endOfMonth;
                    });
                    
                    rangeTitle.textContent = 'æœ¬æœˆä»»åŠ¡';
                } else if (currentRange === 'custom' && customDateFilter.start && customDateFilter.end) {
                    // è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.completedAt);
                        return taskDate >= customDateFilter.start && taskDate <= customDateFilter.end;
                    });
                    
                    const startStr = formatDate(customDateFilter.start);
                    const endStr = formatDate(customDateFilter.end);
                    rangeTitle.textContent = `${startStr} è‡³ ${endStr} çš„ä»»åŠ¡`;
                } else if (currentRange === 'yesterday') {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    filteredTasks = filteredTasks.filter(task => {
                        const d = new Date(task.completedAt);
                        return d >= yesterday && d < today;
                    });
                    rangeTitle.textContent = 'æ˜¨å¤©ä»»åŠ¡';

                } else if (currentRange === 'lastWeek') {
                    const now = new Date();
                    const dayOfWeek = now.getDay() || 7;
                    const startLastWeek = new Date(now);
                    startLastWeek.setDate(now.getDate() - dayOfWeek - 6);
                    startLastWeek.setHours(0, 0, 0, 0);
                    const endLastWeek = new Date(startLastWeek);
                    endLastWeek.setDate(startLastWeek.getDate() + 6);
                    endLastWeek.setHours(23, 59, 59, 999);

                    filteredTasks = filteredTasks.filter(task => {
                        const d = new Date(task.completedAt);
                        return d >= startLastWeek && d <= endLastWeek;
                    });
                    rangeTitle.textContent = 'ä¸Šå‘¨ä»»åŠ¡';
                }


                rangeTitle.classList.remove('hidden');
            }
            
            // ç¡®ä¿åœ¨åˆ‡æ¢è§†å›¾æ—¶å®¹å™¨æ­£ç¡®åˆå§‹åŒ–
            if (currentView === 'list') {
                taskListContainerEl.innerHTML = '';
                chartViewContainer.classList.add('hidden');
                taskListContainerEl.classList.remove('hidden');
                renderTaskList(filteredTasks);
            } else {
                // ä¸ºå›¾è¡¨è§†å›¾åˆ›å»ºå®¹å™¨
                chartViewContainer.innerHTML = `
                    <div class="chart-container">
                        <canvas id="task-chart"></canvas>
                    </div>
                    <div id="chart-legend" class="max-h-[150px] overflow-y-auto text-sm"></div>
                `;
                taskListContainerEl.classList.add('hidden');
                chartViewContainer.classList.remove('hidden');
                renderTaskChart(filteredTasks);
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨è§†å›¾
        function renderTaskList(filteredTasks) {
            taskListContainerEl.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
                return;
            }
            
            noTasksMessage.classList.add('hidden');
            
            // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º
            const tasksByDate = {};
            filteredTasks.forEach(task => {
                const date = new Date(task.completedAt);
                const dateStr = date.toLocaleDateString();
                
                if (!tasksByDate[dateStr]) {
                    tasksByDate[dateStr] = [];
                }
                
                tasksByDate[dateStr].push(task);
            });
            
            // ç”ŸæˆHTML
            Object.keys(tasksByDate).forEach(dateStr => {
                const dateGroup = document.createElement('div');
                dateGroup.className = 'mb-4';
                
                const dateHeader = document.createElement('h3');
                dateHeader.className = 'text-sm font-semibold text-gray-500 mb-2';
                dateHeader.textContent = dateStr;
                dateGroup.appendChild(dateHeader);
                
                tasksByDate[dateStr].forEach(task => {
                    const taskElement = createTaskElement(task);
                    dateGroup.appendChild(taskElement);
                });
                
                taskListContainerEl.appendChild(dateGroup);
            });
        }
        
        // åˆ›å»ºä»»åŠ¡å…ƒç´ 
        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item';
            taskElement.dataset.id = task.id;
            
            const date = new Date(task.completedAt);
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            taskElement.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <h3 class="font-medium text-dark">${escapeHtml(task.name)}</h3>
                    <span class="badge bg-primary/10 text-primary">${task.actualMinutes} åˆ†é’Ÿ</span>
                </div>
                <div class="flex justify-between text-sm text-gray-500">
                    <span>${timeStr}</span>
                    <div class="flex gap-1">
                        <button class="edit-task-btn text-primary hover:text-primary/80" title="ç¼–è¾‘">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-task-btn text-danger hover:text-danger/80" title="åˆ é™¤">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${task.notes ? `<p class="text-xs text-gray-600 mt-2 line-clamp-2">${escapeHtml(task.notes)}</p>` : ''}
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - æŸ¥çœ‹è¯¦æƒ…
            taskElement.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-task-btn') && !e.target.closest('.edit-task-btn')) {
                    showTaskDetails(task.id);
                }
            });
            
            // ç¼–è¾‘æŒ‰é’®
            taskElement.querySelector('.edit-task-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openEditTaskModal(task.id);
            });
            
            // åˆ é™¤æŒ‰é’®
            taskElement.querySelector('.delete-task-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openDeleteTaskModal(task.id);
            });
            
            return taskElement;
        }
        
        // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
        function showTaskDetails(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const date = new Date(task.completedAt);
            const formattedDate = date.toLocaleString();
            
            // æŸ¥æ‰¾è¯¥ä»»åŠ¡çš„å¤ä¹ è®¡åˆ’
            const taskReviews = reviews.filter(r => r.taskId === taskId);
            let reviewsHtml = '';
            
            if (taskReviews.length > 0) {
                reviewsHtml = '<div class="mt-4"><h4 class="font-medium mb-2">å¤ä¹ è®¡åˆ’:</h4><ul class="text-sm">';
                taskReviews.forEach(review => {
                    const reviewDate = new Date(review.reviewDate);
                    const statusClass = review.completed ? 'text-secondary' : 'text-primary';
                    const statusText = review.completed ? 'å·²å®Œæˆ' : 'å¾…å¤ä¹ ';
                    
                    reviewsHtml += `
                        <li class="mb-1 flex justify-between">
                            <span>${formatDate(reviewDate)}</span>
                            <span class="${statusClass}">${statusText}</span>
                        </li>
                    `;
                });
                reviewsHtml += '</ul></div>';
            } else {
                reviewsHtml = '<div class="mt-4 text-sm text-gray-500">æš‚æ— å¤ä¹ è®¡åˆ’</div>';
            }
            
            taskDetailsContent.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-sm text-gray-500">ä»»åŠ¡åç§°</h4>
                    <p class="font-medium">${escapeHtml(task.name)}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <h4 class="text-sm text-gray-500">è®¡åˆ’æ—¶é•¿</h4>
                        <p>${task.plannedMinutes} åˆ†é’Ÿ</p>
                    </div>
                    <div>
                        <h4 class="text-sm text-gray-500">å®é™…æ—¶é•¿</h4>
                        <p>${task.actualMinutes} åˆ†é’Ÿ</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="text-sm text-gray-500">å®Œæˆæ—¶é—´</h4>
                    <p>${formattedDate}</p>
                </div>
                
                ${task.notes ? `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <h4 class="text-sm text-gray-500 mb-1">å¤‡æ³¨</h4>
                    <p class="text-sm">${escapeHtml(task.notes)}</p>
                </div>
                ` : ''}
                
                ${reviewsHtml}
                
                <div class="mt-4 flex justify-end">
                    <button class="view-edit-task-btn px-4 py-1.5 bg-primary text-white rounded-lg text-sm btn-hover">
                        ç¼–è¾‘ä»»åŠ¡
                    </button>
                </div>
            `;
            
            // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
            taskDetailsContent.querySelector('.view-edit-task-btn').addEventListener('click', () => {
                taskDetailsModal.classList.add('hidden');
                openEditTaskModal(task.id);
            });
            
            taskDetailsModal.classList.remove('hidden');
        }
        
        function renderTaskChart(filteredTasks) {
            // é‡å»ºå®¹å™¨
            const container = document.getElementById('chart-view-container');
            container.innerHTML =
                '<div class="chart-container relative w-full aspect-square max-w-md mx-auto my-6">' +
                '<canvas id="task-chart"></canvas>' +
                '</div>' +
                '<div id="chart-legend" class="max-h-[150px] overflow-y-auto text-sm"></div>';

            const canvas = document.getElementById('task-chart');
            if (taskChartInstance) taskChartInstance.destroy();
            const legendContainer = document.getElementById('chart-legend');

            if (filteredTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— ä»»åŠ¡è®°å½•</p>';
                return;
            }

            /* ---------- æ•°æ®å¤„ç† ---------- */
            const taskMap = {};
            filteredTasks.forEach(t => {
                if (!taskMap[t.name]) taskMap[t.name] = { total: 0, tasks: [] };
                taskMap[t.name].total += t.actualMinutes;
                taskMap[t.name].tasks.push(t);
            });

            const labels = Object.keys(taskMap);
            const data = labels.map(name => taskMap[name].total);
            const totalMin = data.reduce((a, b) => a + b, 0);

            /* ---------- å›¾è¡¨ ---------- */
            const ctx = canvas.getContext('2d');
            taskChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: generateColors(labels.length), borderWidth: 1 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: c => `${c.label}: ${c.raw} åˆ†é’Ÿ (${Math.round(c.raw / totalMin * 100)}%)`
                            }
                        }
                    },
                    onClick: (e, elements) => {
                        if (elements.length) {
                            const idx = elements[0].index;
                            const firstTask = taskMap[labels[idx]].tasks[0];
                            showTaskDetails(firstTask.id);
                        }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    beforeDraw(chart) {
                        const { ctx, width, height } = chart;
                        ctx.save();
                        const fontSize = Math.min(width, height) / 18; // æ”¾å¤§
                        ctx.font = `bold ${fontSize}px Inter`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#1f2937';

                        const h = Math.floor(totalMin / 60);
                        const m = totalMin % 60;
                        const txt = h > 0 ? `${h}å°æ—¶${m}åˆ†é’Ÿ` : `${m}åˆ†é’Ÿ`;
                        ctx.fillText(txt, width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });

            /* ---------- å›¾ä¾‹ ---------- */
            legendContainer.innerHTML = '';
            labels.forEach((name, i) => {
                const pct = Math.round(taskMap[name].total / totalMin * 100);
                const item = document.createElement('div');
                item.className = 'flex items-center mb-1 cursor-pointer hover:opacity-80';
                item.innerHTML =
                    `<div class="w-3 h-3 rounded-full mr-2" style="background:${generateColors(labels.length)[i]}"></div>
       <span class="flex-grow truncate">${escapeHtml(name)}</span>
       <span class="text-gray-600">${taskMap[name].total} åˆ†é’Ÿ (${pct}%)</span>`;
                item.onclick = () => showTaskDetails(taskMap[name].tasks[0].id);
                legendContainer.appendChild(item);
            });
        }
        
        // ç”Ÿæˆä¸åŒçš„é¢œè‰²
        function generateColors(count) {
            const colors = [];
            const hueStep = 360 / count;
            
            for (let i = 0; i < count; i++) {
                const hue = (i * hueStep) % 360;
                // ä¿æŒè¾ƒé«˜çš„é¥±å’Œåº¦å’Œé€‚ä¸­çš„äº®åº¦ï¼Œç¡®ä¿é¢œè‰²é²œæ˜ä¸”æœ‰åŒºåˆ«
                colors.push(`hsl(${hue}, 70%, 60%)`);
            }
            
            return colors;
        }
        
        // æ‰“å¼€ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†
        function openEditTaskModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editTaskIdInput.value = task.id;
            editTaskNameInput.value = task.name;
            editTaskPlannedInput.value = task.plannedMinutes;
            editTaskActualInput.value = task.actualMinutes;
            editTaskNotesInput.value = task.notes;
            editTaskDateInput.value = formatDateTimeLocal(new Date(task.completedAt));
            
            // æŸ¥æ‰¾è¯¥ä»»åŠ¡çš„å¤ä¹ è®¡åˆ’
            const taskReviews = reviews.filter(r => r.taskId === taskId);
            if (taskReviews.length > 0) {
                const days = [...new Set(taskReviews.map(r => r.daysLater))].sort((a, b) => a - b);
                editReviewDaysInput.value = days.join(',');
            } else {
                editReviewDaysInput.value = '';
            }
            
            editTaskModal.classList.remove('hidden');
        }
        
        // ä¿å­˜ç¼–è¾‘çš„ä»»åŠ¡
        function saveEditedTask() {
            const taskId = editTaskIdInput.value;
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) {
                showNotification('ä»»åŠ¡ä¸å­˜åœ¨');
                return;
            }
            
            if (!editTaskNameInput.value.trim()) {
                showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                return;
            }
            
            // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                name: editTaskNameInput.value,
                notes: editTaskNotesInput.value,
                plannedMinutes: parseInt(editTaskPlannedInput.value),
                actualMinutes: parseInt(editTaskActualInput.value),
                completedAt: new Date(editTaskDateInput.value).toISOString()
            };
            
            // æ›´æ–°ç›¸å…³çš„å¤ä¹ è®°å½•
            reviews.forEach(review => {
                if (review.taskId === taskId) {
                    review.taskName = editTaskNameInput.value;
                    review.taskNotes = editTaskNotesInput.value;
                }
            });
            
            saveData();
            renderTasks();
            renderReviews();
            editTaskModal.classList.add('hidden');
            showNotification('ä»»åŠ¡å·²æ›´æ–°');
        }
        
        // æ‰“å¼€åˆ é™¤ä»»åŠ¡æ¨¡æ€æ¡†
        function openDeleteTaskModal(taskId) {
            currentTaskId = taskId;
            deleteTaskModal.classList.remove('hidden');
        }
        
        // ç¡®è®¤åˆ é™¤ä»»åŠ¡
        function confirmDeleteTask() {
            if (!currentTaskId) return;
            
            // åˆ é™¤ä»»åŠ¡
            tasks = tasks.filter(task => task.id !== currentTaskId);
            
            // åˆ é™¤ç›¸å…³çš„å¤ä¹ è®¡åˆ’
            reviews = reviews.filter(review => review.taskId !== currentTaskId);
            
            saveData();
            renderTasks();
            renderReviews();
            deleteTaskModal.classList.add('hidden');
            showNotification('ä»»åŠ¡å·²åˆ é™¤');
        }
        
        // æ·»åŠ æ–°ä»»åŠ¡
        // æ·»åŠ æ–°ä»»åŠ¡
        function addNewTask() {
            if (!newTaskNameInput.value.trim()) {
                showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                return;
            }

            const task = {
                id: Date.now().toString(),
                name: newTaskNameInput.value,
                notes: newTaskNotesInput.value,
                plannedMinutes: parseInt(newTaskPlannedInput.value),
                actualMinutes: parseInt(newTaskActualInput.value),
                completedAt: newTaskDateInput.value ? new Date(newTaskDateInput.value).toISOString() : new Date().toISOString()
            };

            tasks.unshift(task);

            // å¤„ç†å¤ä¹ è®¡åˆ’
            const reviewDaysInput = document.getElementById('new-review-days');
            if (reviewDaysInput.value.trim()) {
                const daysArray = reviewDaysInput.value.split(',').map(day => parseInt(day.trim())).filter(day => !isNaN(day) && day > 0);
                daysArray.forEach(days => {
                    const reviewDate = new Date(task.completedAt);
                    reviewDate.setDate(reviewDate.getDate() + days);
                    const review = {
                        id: Date.now().toString() + '-' + days + '-' + task.id,
                        taskId: task.id,
                        taskName: task.name,
                        taskNotes: task.notes,
                        daysLater: days,
                        reviewDate: reviewDate.toISOString(),
                        completed: false
                    };
                    reviews.push(review);
                });
            }

            saveData();
            renderTasks();
            renderReviews();
            addTaskModal.classList.add('hidden');
            showNotification('ä»»åŠ¡å·²æ·»åŠ ');
        }
        
        // æ¸²æŸ“å¤ä¹ è®°å½•
        function renderReviews() {
            reviewList.innerHTML = '';
            
            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤å¤ä¹ 
            let filteredReviews = [...reviews];
            
            if (currentReviewFilter === 'upcoming') {
                // è·å–ä»Šå¤©0ç‚¹0åˆ†0ç§’ï¼ˆä½œä¸ºä»Šå¤©çš„å¼€å§‹ï¼‰
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                // è®¡ç®—1ä¸ªæœˆåçš„æ—¶é—´ç‚¹
                const oneMonthLater = new Date();
                oneMonthLater.setMonth(oneMonthLater.getMonth() + 1);

                // ç­›é€‰æ¡ä»¶ï¼šä»Šå¤©0ç‚¹è‡³1ä¸ªæœˆåä¹‹é—´çš„æ‰€æœ‰è®°å½•
                filteredReviews = filteredReviews.filter(review => {
                    const reviewDate = new Date(review.reviewDate);
                    return reviewDate >= todayStart && reviewDate <= oneMonthLater;
                });

                // æŒ‰æ—¥æœŸæ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
                filteredReviews.sort((a, b) => new Date(a.reviewDate) - new Date(b.reviewDate));

                reviewRangeTitle.textContent = 'ä»Šå¤©è‡³ä¸€ä¸ªæœˆå';
                reviewRangeTitle.classList.remove('hidden');
            } else if (currentReviewFilter === 'all') {
                reviewDateRangeFilter.classList.remove('hidden');
                
                if (currentReviewRange === 'day') {
                    // ä»…ä»Šå¤©
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    filteredReviews = filteredReviews.filter(review => {
                        const reviewDate = new Date(review.reviewDate);
                        return reviewDate >= today && reviewDate < tomorrow;
                    });
                    
                    reviewRangeTitle.textContent = 'ä»Šæ—¥å¤ä¹ ';
                } else if (currentReviewRange === 'week') {
                    // æœ¬å‘¨ï¼ˆä»å‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
                    const now = new Date();
                    const dayOfWeek = now.getDay() || 7; // è®©å‘¨æ—¥ä¸º7è€Œä¸æ˜¯0
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - (dayOfWeek - 1));
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    
                    filteredReviews = filteredReviews.filter(review => {
                        const reviewDate = new Date(review.reviewDate);
                        return reviewDate >= startOfWeek && reviewDate <= endOfWeek;
                    });
                    
                    reviewRangeTitle.textContent = 'æœ¬å‘¨å¤ä¹ ';
                } else if (currentReviewRange === 'month') {
                    // æœ¬æœˆ
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endOfMonth.setHours(23, 59, 59, 999);
                    
                    filteredReviews = filteredReviews.filter(review => {
                        const reviewDate = new Date(review.reviewDate);
                        return reviewDate >= startOfMonth && reviewDate <= endOfMonth;
                    });
                    
                    reviewRangeTitle.textContent = 'æœ¬æœˆå¤ä¹ ';
                } else if (currentReviewRange === 'custom' && customReviewFilter.start && customReviewFilter.end) {
                    // è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
                    filteredReviews = filteredReviews.filter(review => {
                        const reviewDate = new Date(review.reviewDate);
                        return reviewDate >= customReviewFilter.start && reviewDate <= customReviewFilter.end;
                    });
                    
                    const startStr = formatDate(customReviewFilter.start);
                    const endStr = formatDate(customReviewFilter.end);
                    reviewRangeTitle.textContent = `${startStr} è‡³ ${endStr} çš„å¤ä¹ `;
                } else if (currentReviewRange === 'yesterday') {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    filteredReviews = filteredReviews.filter(r => {
                        const d = new Date(r.reviewDate);
                        return d >= yesterday && d < today;
                    });
                    reviewRangeTitle.textContent = 'æ˜¨å¤©å¤ä¹ ';

                } else if (currentReviewRange === 'lastWeek') {
                    const now = new Date();
                    const dayOfWeek = now.getDay() || 7;
                    const startLastWeek = new Date(now);
                    startLastWeek.setDate(now.getDate() - dayOfWeek - 6);
                    startLastWeek.setHours(0, 0, 0, 0);
                    const endLastWeek = new Date(startLastWeek);
                    endLastWeek.setDate(startLastWeek.getDate() + 6);
                    endLastWeek.setHours(23, 59, 59, 999);

                    filteredReviews = filteredReviews.filter(r => {
                        const d = new Date(r.reviewDate);
                        return d >= startLastWeek && d <= endLastWeek;
                    });
                    reviewRangeTitle.textContent = 'ä¸Šå‘¨å¤ä¹ ';
                }
                
                // æŒ‰æ—¥æœŸæ’åº
                filteredReviews.sort((a, b) => new Date(a.reviewDate) - new Date(b.reviewDate));
                
                reviewRangeTitle.classList.remove('hidden');
            }
            
            if (filteredReviews.length === 0) {
                noReviewsMessage.classList.remove('hidden');
                return;
            }
            
            noReviewsMessage.classList.add('hidden');
            
            // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º
            const reviewsByDate = {};
            filteredReviews.forEach(review => {
                const date = new Date(review.reviewDate);
                const dateStr = date.toLocaleDateString();
                
                if (!reviewsByDate[dateStr]) {
                    reviewsByDate[dateStr] = [];
                }
                
                reviewsByDate[dateStr].push(review);
            });
            
            // ç”ŸæˆHTML
            Object.keys(reviewsByDate).forEach(dateStr => {
                const dateGroup = document.createElement('div');
                dateGroup.className = 'mb-4';
                
                const dateHeader = document.createElement('h3');
                dateHeader.className = 'text-sm font-semibold text-gray-500 mb-2';
                
                // æ ‡è®°ä»Šå¤©å’Œæ˜å¤©
                const today = new Date().toLocaleDateString();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toLocaleDateString();
                
                if (dateStr === today) {
                    dateHeader.innerHTML = `<span class="text-primary">ä»Šå¤©</span> (${dateStr})`;
                } else if (dateStr === tomorrowStr) {
                    dateHeader.innerHTML = `<span class="text-accent">æ˜å¤©</span> (${dateStr})`;
                } else {
                    dateHeader.textContent = dateStr;
                }
                
                dateGroup.appendChild(dateHeader);
                
                reviewsByDate[dateStr].forEach(review => {
                    const reviewElement = createReviewElement(review);
                    dateGroup.appendChild(reviewElement);
                });
                
                reviewList.appendChild(dateGroup);
            });
        }
        
        // åˆ›å»ºå¤ä¹ å…ƒç´ 
        function createReviewElement(review) {
            const reviewElement = document.createElement('div');
            const reviewDate = new Date(review.reviewDate);
            const now = new Date();

            // è·å–ä»»åŠ¡å®Œæˆæ—¥æœŸ
            const task = tasks.find(t => t.id === review.taskId);
            const taskCompletedAt = new Date(task.completedAt);

            // è®¡ç®—è¿™æ˜¯ç¬¬å‡ æ¬¡å¤ä¹ 
            const allReviewsForTask = reviews.filter(r => r.taskId === review.taskId).sort((a, b) => a.daysLater - b.daysLater);
            const reviewIndex = allReviewsForTask.findIndex(r => r.id === review.id) + 1;

            // çŠ¶æ€æ ·å¼
            const reviewDateOnly = new Date(reviewDate.getFullYear(), reviewDate.getMonth(), reviewDate.getDate());
            const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            let statusClass = '';
            let statusText = '';

            if (review.completed) {
                statusClass = 'bg-secondary/10 text-secondary border-secondary';
                statusText = 'å·²å®Œæˆ';
            } else if (reviewDateOnly < nowDateOnly) {
                statusClass = 'bg-warning/10 text-warning border-warning';
                statusText = 'å·²é€¾æœŸ';
            } else {
                statusClass = 'bg-primary/10 text-primary border-primary';
                statusText = 'å¾…å¤ä¹ ';
            }

            reviewElement.className = `task-item ${statusClass}`;
            reviewElement.dataset.id = review.id;

            reviewElement.innerHTML = `
        <div class="flex justify-between items-start mb-1">
            <h3 class="font-medium">${escapeHtml(review.taskName)}</h3>
            <span class="badge">${statusText}</span>
        </div>
        <div class="text-sm text-gray-500 mb-1">
            å®Œæˆæ—¥æœŸï¼š${formatDate(taskCompletedAt)}
        </div>
        
        <div class="text-sm text-gray-500 mb-1">
            å¤ä¹ æ—¥æœŸï¼š${formatDate(reviewDate)} 
        </div>
        <div class="text-sm text-gray-500 mb-1">
            ç¬¬ ${reviewIndex} æ¬¡å¤ä¹ ï¼ˆ+${review.daysLater} å¤©ï¼‰
        </div>
        ${review.taskNotes ? `<div class="review-note">${escapeHtml(review.taskNotes)}</div>` : ''}
    `;

            // å•å‡»æ˜¾ç¤º/éšè—å¤‡æ³¨
            reviewElement.addEventListener('click', (e) => {
                e.stopPropagation();
                if (review.taskNotes) {
                    const noteElement = reviewElement.querySelector('.review-note');
                    noteElement.classList.toggle('visible');
                }
            });

            // åŒå‡»æ ‡è®°å®Œæˆ/æœªå®Œæˆ
            reviewElement.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                const reviewIndex = reviews.findIndex(r => r.id === review.id);
                if (reviewIndex !== -1) {
                    reviews[reviewIndex].completed = !reviews[reviewIndex].completed;
                    saveData();
                    renderReviews();
                    showNotification(reviews[reviewIndex].completed ? 'å·²æ ‡è®°ä¸ºå®Œæˆ' : 'å·²æ ‡è®°ä¸ºæœªå®Œæˆ');
                }
            });

            return reviewElement;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationToast.classList.remove('translate-x-full');
            
            setTimeout(() => {
                notificationToast.classList.add('translate-x-full');
            }, 3000);
        }
        
        // æ›´æ–°ä»»åŠ¡ç­›é€‰æŒ‰é’®æ ·å¼
        function updateTaskFilters() {
            if (currentFilter === 'today') {
                todayFilter.classList.add('bg-primary', 'text-white');
                todayFilter.classList.remove('bg-gray-200', 'text-gray-700');
                allFilter.classList.add('bg-gray-200', 'text-gray-700');
                allFilter.classList.remove('bg-primary', 'text-white');
                dateRangeFilter.classList.add('hidden');
                rangeTitle.classList.add('hidden');
            } else {
                todayFilter.classList.add('bg-gray-200', 'text-gray-700');
                todayFilter.classList.remove('bg-primary', 'text-white');
                allFilter.classList.add('bg-primary', 'text-white');
                allFilter.classList.remove('bg-gray-200', 'text-gray-700');
                dateRangeFilter.classList.remove('hidden');
                updateRangeButtons();
            }
        }
        
        // æ›´æ–°èŒƒå›´æŒ‰é’®æ ·å¼
        function updateRangeButtons() {
            rangeButtons.forEach(btn => {
                if (btn.dataset.range === currentRange) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
        }
        
        // æ›´æ–°å¤ä¹ ç­›é€‰æŒ‰é’®æ ·å¼
        function updateReviewFilters() {
            if (currentReviewFilter === 'upcoming') {
                upcomingFilter.classList.add('bg-primary', 'text-white');
                upcomingFilter.classList.remove('bg-gray-200', 'text-gray-700');
                allReviewsFilter.classList.add('bg-gray-200', 'text-gray-700');
                allReviewsFilter.classList.remove('bg-primary', 'text-white');
                reviewDateRangeFilter.classList.add('hidden');
                reviewRangeTitle.classList.add('hidden');
            } else {
                upcomingFilter.classList.add('bg-gray-200', 'text-gray-700');
                upcomingFilter.classList.remove('bg-primary', 'text-white');
                allReviewsFilter.classList.add('bg-primary', 'text-white');
                allReviewsFilter.classList.remove('bg-gray-200', 'text-gray-700');
                reviewDateRangeFilter.classList.remove('hidden');
                updateReviewRangeButtons();
            }
        }
        
        // æ›´æ–°å¤ä¹ èŒƒå›´æŒ‰é’®æ ·å¼
        function updateReviewRangeButtons() {
            reviewRangeButtons.forEach(btn => {
                if (btn.dataset.reviewRange === currentReviewRange) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' });
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        // å¯¼å‡ºä»»åŠ¡å’Œå¤ä¹ è®°å½•
        function exportData() {
            const data = {
                tasks: tasks.map(task => ({
                    id: task.id,
                    name: task.name,
                    notes: task.notes,
                    plannedMinutes: task.plannedMinutes,
                    actualMinutes: task.actualMinutes,
                    completedAt: task.completedAt
                })),
                reviews: reviews.map(review => ({
                    id: review.id,
                    taskId: review.taskId,
                    taskName: review.taskName,
                    taskNotes: review.taskNotes,
                    daysLater: review.daysLater,
                    reviewDate: review.reviewDate,
                    completed: review.completed
                }))
            };

            const jsonString = JSON.stringify(data, null, 2); // æ ¼å¼åŒ– JSON æ•°æ®
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // åˆ›å»ºä¸€ä¸ª a æ ‡ç­¾ç”¨äºä¸‹è½½
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pomodoro-data.json'; // è®¾ç½®ä¸‹è½½æ–‡ä»¶å
            a.click();

            // é‡Šæ”¾ URL
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥ä»»åŠ¡å’Œå¤ä¹ è®°å½•
        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                showNotification('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }

            if (!file.type.includes('json')) {
                showNotification('ä»…æ”¯æŒå¯¼å…¥ JSON æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.tasks) {
                        tasks = data.tasks;
                    }
                    if (data.reviews) {
                        reviews = data.reviews;
                    }
                    saveData(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    renderTasks(); // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                    renderReviews(); // é‡æ–°æ¸²æŸ“å¤ä¹ åˆ—è¡¨
                    showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ');
                } catch (error) {
                    showNotification('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                }
            };
            reader.readAsText(file);
        }

        // äº‘åŒæ­¥
        const accountInp = document.getElementById('account');
        document.getElementById('btn-up').onclick = async () => {
            const account = accountInp.value.trim();
            if (!account) return alert('å…ˆè¾“å…¥è´¦å·');
            await fetch('/api/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account,
                    tasks: JSON.parse(localStorage.getItem('pomodoroTasks') || '[]'),
                    reviews: JSON.parse(localStorage.getItem('pomodoroReviews') || '[]')
                })
            });
            showNotification('å·²ä¸Šä¼ ');
        };

        document.getElementById('btn-down').onclick = async () => {
            const account = accountInp.value.trim();
            if (!account) return alert('å…ˆè¾“å…¥è´¦å·');
            const data = await (await fetch(`/api/download?account=${encodeURIComponent(account)}`)).json();
            if (data.tasks) {
                localStorage.setItem('pomodoroTasks', JSON.stringify(data.tasks));
                localStorage.setItem('pomodoroReviews', JSON.stringify(data.reviews));
                loadData();          // é‡æ–°æ¸²æŸ“
                showNotification('å·²ä¸‹è½½å¹¶è¦†ç›–æœ¬åœ°');
            } else {
                showNotification('äº‘ç«¯æ— æ•°æ®');
            }
        };
      

        // ç¡®ä¿åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

